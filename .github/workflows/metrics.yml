name: Metrics
on:
  schedule: [{cron: "0 0 * * *"}]
  workflow_dispatch:
  push: {branches: ["master", "main"]}

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # Step 1: Your existing Isometric Calendar
      - name: Isometric Calendar
        uses: lowlighter/metrics@latest
        with:
          filename: metrics.plugin.isocalendar.fullyear.svg
          token: ${{ secrets.METRICS_TOKEN }}
          base: ""
          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year

      # Step 2: New Achievements Plugin
      #- name: Achievements
      #  uses: lowlighter/metrics@latest
      #  with:
      #    filename: metrics.plugin.achievements.svg
      #    token: ${{ secrets.METRICS_TOKEN }}
      #    base: ""
      #    plugin_achievements: yes
      #    plugin_achievements_display: compact
      #    plugin_achievements_threshold: X
      #    plugin_achievements_secrets: yes
      #    plugin_achievements_limit: 0
      #    #plugin_achievements_ignored: manager, master-of-repo
      # ADD THIS STEP TO YOUR EXISTING metrics.yml
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Custom Achievements SVG
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.METRICS_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Get user data
            const user = context.repo.owner;
            
            // Fetch user stats via GraphQL
            const query = `
              query($login: String!) {
                user(login: $login) {
                  contributionsCollection {
                    totalCommitContributions
                    totalIssueContributions
                    totalPullRequestContributions
                    totalPullRequestReviewContributions
                  }
                  repositories(first: 100, ownerAffiliations: OWNER, orderBy: {field: STARGAZERS, direction: DESC}) {
                    totalCount
                    nodes {
                      stargazerCount
                      forkCount
                      watchers {
                        totalCount
                      }
                    }
                  }
                  followers {
                    totalCount
                  }
                  gists {
                    totalCount
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, { login: user });
            const userData = result.user;
            const contribs = userData.contributionsCollection;
            const repos = userData.repositories.nodes;
            
            // Calculate achievements
            const achievements = [];
            const totalStars = repos.reduce((sum, repo) => sum + repo.stargazerCount, 0);
            const totalForks = repos.reduce((sum, repo) => sum + repo.forkCount, 0);
            const repoCount = userData.repositories.totalCount;
            const commits = contribs.totalCommitContributions;
            const prs = contribs.totalPullRequestContributions;
            const issues = contribs.totalIssueContributions;
            const reviews = contribs.totalPullRequestReviewContributions;
            const followers = userData.followers.totalCount;
            const gists = userData.gists.totalCount;
            
            // Define achievements
            if (commits >= 1000) achievements.push({ name: 'Commit Champion', icon: 'üí™', desc: '1000+ commits' });
            else if (commits >= 500) achievements.push({ name: 'Code Warrior', icon: '‚öîÔ∏è', desc: '500+ commits' });
            else if (commits >= 100) achievements.push({ name: 'Contributor', icon: '‚ú®', desc: '100+ commits' });
            
            if (totalStars >= 1000) achievements.push({ name: 'Star Collector', icon: 'üåü', desc: '1000+ stars' });
            else if (totalStars >= 100) achievements.push({ name: 'Rising Star', icon: '‚≠ê', desc: '100+ stars' });
            else if (totalStars >= 10) achievements.push({ name: 'Stargazer', icon: '‚ú®', desc: '10+ stars' });
            
            if (repoCount >= 50) achievements.push({ name: 'Repository Master', icon: 'üìö', desc: '50+ repositories' });
            else if (repoCount >= 20) achievements.push({ name: 'Builder', icon: 'üî®', desc: '20+ repositories' });
            
            if (prs >= 100) achievements.push({ name: 'PR Hero', icon: 'üöÄ', desc: '100+ pull requests' });
            else if (prs >= 50) achievements.push({ name: 'Collaborator', icon: 'ü§ù', desc: '50+ pull requests' });
            
            if (followers >= 100) achievements.push({ name: 'Influencer', icon: 'üë•', desc: '100+ followers' });
            else if (followers >= 50) achievements.push({ name: 'Popular', icon: 'üë§', desc: '50+ followers' });
            
            if (totalForks >= 50) achievements.push({ name: 'Fork Master', icon: 'üç¥', desc: '50+ forks' });
            
            if (reviews >= 50) achievements.push({ name: 'Code Reviewer', icon: 'üëÅÔ∏è', desc: '50+ reviews' });
            
            if (issues >= 50) achievements.push({ name: 'Issue Tracker', icon: 'üêõ', desc: '50+ issues' });
            
            if (gists >= 10) achievements.push({ name: 'Gist Guru', icon: 'üìù', desc: '10+ gists' });
            
            // Generate SVG
            const width = 900;
            const achievementRows = Math.ceil(Math.max(achievements.length, 1) / 3);
            const height = 120 + (achievementRows * 80);
            
            // Escape XML characters
            const escapeXml = (str) => {
              return str.replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&apos;');
            };
            
            const achievementCards = achievements.length > 0 
              ? achievements.map((achievement, index) => {
                  const row = Math.floor(index / 3);
                  const col = index % 3;
                  const x = 20 + (col * 290);
                  const y = 90 + (row * 80);
                  
                  return `<g>
                  <rect class="achievement-card" x="${x}" y="${y}" width="280" height="70" rx="6"/>
                  <text class="achievement-icon" x="${x + 15}" y="${y + 45}">${achievement.icon}</text>
                  <text class="achievement-name" x="${x + 65}" y="${y + 30}">${escapeXml(achievement.name)}</text>
                  <text class="achievement-desc" x="${x + 65}" y="${y + 50}">${escapeXml(achievement.desc)}</text>
                </g>`;
                }).join('\n')
              : `<g>
                  <rect class="achievement-card" x="20" y="90" width="860" height="70" rx="6"/>
                  <text class="achievement-name" x="440" y="125" text-anchor="middle">Keep coding to unlock achievements! üöÄ</text>
                </g>`;
            
            const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .bg { fill: #0d1117; }
      .title { fill: #c9d1d9; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif; font-size: 24px; font-weight: bold; }
      .subtitle { fill: #8b949e; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif; font-size: 14px; }
      .achievement-card { fill: #161b22; stroke: #30363d; stroke-width: 1; }
      .achievement-icon { font-size: 32px; }
      .achievement-name { fill: #c9d1d9; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif; font-size: 14px; font-weight: 600; }
      .achievement-desc { fill: #8b949e; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif; font-size: 12px; }
    </style>
  </defs>
  
  <rect class="bg" width="${width}" height="${height}" rx="4.5"/>
  
  <text class="title" x="20" y="40">üèÜ GitHub Achievements</text>
  <text class="subtitle" x="20" y="65">${achievements.length} achievement${achievements.length !== 1 ? 's' : ''} unlocked</text>
  
  ${achievementCards}
  
  <text class="subtitle" x="${width - 20}" y="${height - 15}" text-anchor="end">‚≠ê ${totalStars} | üîÄ ${totalForks} | üì¶ ${repoCount}</text>
</svg>`;
            
            // Save SVG
            fs.writeFileSync('metrics.plugin.achievements.svg', svg);
            console.log('‚úÖ Achievements SVG generated successfully!');
            console.log(`üìä Total achievements: ${achievements.length}`);

      # Your existing Isometric Calendar and other steps will remain here
      # The achievements SVG will be auto-committed with your existing commit logic
